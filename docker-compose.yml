version: '3.8'

services:
  # =========================================
  # 1. MySQL 数据库服务
  # =========================================
  mysqldb:
    image: mysql:8.0
    container_name: mysqldb
    restart: always
    environment:
      - MYSQL_ROOT_PASSWORD=123456
      - MYSQL_DATABASE=forgery_detection
      - TZ=Asia/Shanghai
    command: --character-set-server=utf8mb4 --collation-server=utf8mb4_unicode_ci
    ports:
      - "3307:3306" # 映射到宿主机3307，防止和本地MySQL(3306)冲突
    volumes:
      # 数据持久化：防止重启容器后数据丢失
      - ./docker-data/mysql:/var/lib/mysql
      # 初始化脚本： .sql 文件放在项目根目录的 sql/ 文件夹下，启动时会自动导入
      - ./sql:/docker-entrypoint-initdb.d

  # =========================================
  # 2. Redis 缓存服务
  # =========================================
  redisdb:
    image: redis:7.0-alpine
    container_name: redisdb
    restart: always
    ports:
      - "6380:6379" # 映射到宿主机6380，防止冲突
    command: redis-server --appendonly yes

  # =========================================
  # 3. Python 算法服务 (ML Service)
  # =========================================
  ml-service:
    build:
      context: ./ml_service # 指定构建目录
      dockerfile: Dockerfile
    container_name: ml-service
    restart: always
    ports:
      - "5000:5000"
    environment:
      - TZ=Asia/Shanghai

  # =========================================
  # 4. Java 后端服务 (Backend App)
  # =========================================
  backend-app:
    build: . # 使用根目录的 Dockerfile
    container_name: backend-app
    restart: always
    depends_on:
      - mysqldb
      - redisdb
      - ml-service
    ports:
      - "8080:8080"
    environment:
      # 强制激活 prod 环境，读取 application-prod.properties
      - SPRING_PROFILES_ACTIVE=prod
      - TZ=Asia/Shanghai
    volumes:
      # 把宿主机的上传目录映射进去
      # 格式：宿主机路径:容器路径
      # 项目根目录下建好了 forgery_uploads 文件夹
      - ./forgery_uploads:/app/uploads

  # =========================================
  # 5. Nginx 网关 (可选，目前先用8080直连)
  # =========================================
  nginx:
    image: nginx:stable-alpine
    container_name: nginx-gateway
    restart: always
    ports:
      - "80:80" # 以后只用访问 80 端口
    volumes:
      # 1. 挂载配置文件
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      # 2. 挂载上传的图片目录 (让 Nginx 能直接读取图片)
      - ./forgery_uploads:/usr/share/nginx/html/files
    depends_on:
      - backend-app